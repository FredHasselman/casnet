---
title: "Using the CRQA command line interface (crqa_cl)"
author: "Fred Hasselman"
date: "`r Sys.Date()`"
bibliography: bibliography.bib
csl: apa.csl
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{cl_RQA}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = FALSE,
  comment = ">",
  fig.align = "center",
  fig.width = 7 
)
```

## **An R interface to Marwan's commandline recurrence plots**

The `crqa_cl()` function is a wrapper for the \href{http://tocsy.pik-potsdam.de/commandline-rp.php}{commandline Recurrence Plots} executables provided by Norbert Marwan. 

The `rp` executable is installed when the function is called for the first time:

* It is renamed to `rp` from a platform specific filename located in the directory: `r normalizePath("[path to casnet]/commandline_rp/",mustWork = FALSE)`
* The file is copied to the directory: `r normalizePath("[path to casnet]/exec/",mustWork = FALSE)`
* The latter location is stored as an option and can be read by calling `getOption("casnet.path_to_rp")`

---

Note that the platform specific `rp` command line executables were created by Norbert Marwan and obtained under a Creative Commons License from the website of the Potsdam Institute for Climate Impact Research at: http://tocsy.pik-potsdam.de/


The full copyright statement on the website is as follows:    

> Â© 2004-2017 SOME RIGHTS RESERVED    
> University of Potsdam, Interdisciplinary Center for Dynamics of Complex Systems, Germany    
> Potsdam Institute for Climate Impact Research, Transdisciplinary Concepts and Methods, Germany    
> This work is licensed under a [Creative Commons Attribution-NonCommercial-NoDerivs 2.0 Germany License](https://creativecommons.org/licenses/by-nc-nd/2.0/de/).    

More information about recurrence quantification analysis can be found on the [Recurrence Plot website](http://www.recurrence-plot.tk).


## Auto RQA

We'll use data from @oomens2015 in which 242 students were asked to generate random sequences of 100 numbers between 1 and 9 (for details see [the article](https://www.frontiersin.org/articles/10.3389/fnhum.2015.00319/full)).

```{r RNG1, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(casnet)
library(ggplot2)

# Load the random number sequence data from Oomens et al. (2015)
data(RNG)

# Select a subject
IDs <- RNG$ID%in%c(163,291)

# Look at the sequence
ggplot(RNG[IDs,],aes(x=time,y=number,group=ID)) +
  geom_line(aes(colour=ID))+
  facet_grid(~ID) +
  scale_y_continuous(breaks = 1:9) +
  ggtitle("Which of these number sequences is more 'random'?") +
  theme_bw()
```

In order to answer the question in the Figure title, we'll run a Recurrence Quantification Analysis.

The data are unordered categorical, that is, the differences between the integers are meaningless in the context of generating random number sequences. This means the RQA parameters can be set to quantify recurrences of the same value: 

* Embedding lag = 1
* Embedding dimension = 1
* Radius = 0 (any number $\leq$ 1 will do)

In the code block below the functions `crqa_cl()`, `recmat()`, `di2bi()` and `recmat_plot()` are used to perform RQA on 2 participants in the dataset.

```{r RNG2, message=FALSE, warning=FALSE, cache=TRUE, collapse=FALSE, include=FALSE, echo=TRUE, paged.print=FALSE}
# Run the RQA analysis
y_1  <- RNG$number[RNG$ID==163]
y_2 <-  RNG$number[RNG$ID==291]
crqa_1 <- crqa_cl(y1 = y_1, eDim  = 1, eLag = 1, eRad= 1)$rqa_measures
crqa_2 <- crqa_cl(y1 = y_2, eDim  = 1, eLag = 1, eRad= 1)$rqa_measures

## Plot the recurrence matrix
# Get the matrix
rp_1 <- recmat(y1=y_1, y2=y_1, emDim = 1, emLag = 1)
rp_2 <- recmat(y1=y_2, y2=y_2, emDim = 1, emLag = 1)

# Turn it into a recurrence matrix
rp_1 <- di2bi(rp_1,radius = 1)
rp_2 <- di2bi(rp_2,radius = 1)

# Get the plots
g_1 <- recmat_plot(rp_1, doPlot=FALSE)
g_2 <- recmat_plot(rp_2, doPlot=FALSE)
```

Below the data and plots are rearranged for ease of comparison.

```{r RNG3, echo=TRUE, message=FALSE, warning=FALSE, cache=TRUE, paged.print=FALSE}
library(cowplot)
# The recurrence plots
plot_grid(g_1, g_2, labels = c("ID 163", "ID 291"), align = "h")

# The RQA measures
cbind.data.frame(subj163=t(crqa_1), subj291=t(crqa_2))
```

The sequence generated by participant 163 has a higher **DET**erminism (`DET = .40`) than the sequence by particpant 291 (`DET = .19`). The ratio of points on a diagonal line to the total number of recurrent point also quantifies this difference (`DET_RR`). Also interesting to note, both participants have a **LAM**inarity score of `0`. This implies they avoided to produce patterns in which the exact same numbers were repeated in succession. This is a tell-tale sign of the *non-random* origins of these sequences.


### **Do the shuffle!**
A simple strategy to get some more certainty about the differences between the two sequences is to randomise the observed series, thus removing any temporal correlations that might give rise to recurring patterns in the sequences and re-run the RQA. If the repeated patterns generated by participant 163 are non-random one would expect the **DET**erminism to drop. If they do not drop this could indicate some random autoregressive process is causing apparent deterministic temporal patterns.

```{r RNG4, echo=TRUE, message=FALSE, warning=FALSE, cache=TRUE, paged.print=FALSE}
# Reproduce the same randomisation
set.seed(123456789)

# Randomise the number sequences
y_1rnd <- y_1[sample(1:NROW(y_1),size = NROW(y_1))]
y_2rnd <- y_2[sample(1:NROW(y_2),size = NROW(y_2))]

# Calculate RQA measures
crqa_1rnd <- crqa_cl(y1 = y_1rnd, eDim  = 1, eLag = 1, eRad= 1)$rqa_measures
crqa_2rnd <- crqa_cl(y1 = y_2rnd, eDim  = 1, eLag = 1, eRad= 1)$rqa_measures

# Get the RPs in one statement
g_1rnd <- recmat_plot(di2bi(recmat(y1=y_1rnd, y2=y_1rnd, emDim = 1, emLag = 1), radius=1), doPlot=FALSE)
g_2rnd <- recmat_plot(di2bi(recmat(y1=y_2rnd, y2=y_2rnd, emDim = 1, emLag = 1), radius=1), doPlot=FALSE)

# Display recurrence plots
cowplot::plot_grid(g_1rnd, g_2rnd, labels = c("ID 163 shuffled", "ID 291 shuffled"), align = "h")

# Display the RQA measures
cbind.data.frame(subj163=t(crqa_1), subj163rnd=t(crqa_1rnd), subj291=t(crqa_2),  subj291rnd=t(crqa_2rnd))
```

Note that the number of recurrent points (`RR`) does not change whe we shuffle the data. What changes is the number of recurrent points that form line structures in the recurrence plot. Randomising the number sequences causes vertical line structures to appear in the recurrence plot (`LAM`, `V_max`, `V_entr`, `TT`), this is what we would expect if the data generating process were indeed a random process. Having no such structures means there were hardly any sequences consisting of repetitions of the same number. Participants may have adopted a strategy to avoid such sequences because they erroneously believed this to be a feature of non-random sequences.


### **Hypothesis testing using constrained data realisations**
In order to get an idea about the meanignfulness of these differences, we can construct a surrogate data test for each participant. If we want a one-sided test with $\alpha=.05$, the formula for the number of constrained realisations $M$ we minimally need is: $$M = \frac{1}{\alpha}-1 = 19$$. Add the observed value and we have a sample size of $N = 20$. For a two sided test we would use $$M = \frac{2}{\alpha}-1 = 39$$.    

Of course, if there are no computational constraints on generating surrogate time series, we can go much higher, If we want $N = 100$, the test will be an evaluation of $H_{0}$ at $\alpha = .01$.

1. Create `99` realisations that reflect a test of the hypothesis $H_{0}: X_i \sim \mathcal{U(1,9)}$ at $\alpha = .01$.
2. Calculate the measure of interest, e.g. `DET`
3. If the observed `DET` value is at the extremes of the distribution of values representing $H_{0}$, the observed value was probably not generated by drawing from a discrete uniform distribution with finite elements `1` through `9`.

```{r RNG5, message=FALSE, warning=FALSE, cache=TRUE, include=FALSE, echo=TRUE, paged.print=FALSE}
library(plyr)
library(dplyr)

set.seed(123456789)

y_1rnd_sur <- ldply(1:99, function(s) y_1[sample(1:NROW(y_1),size = NROW(y_1))])
y_2rnd_sur <- ldply(1:99, function(s) y_2[sample(1:NROW(y_2),size = NROW(y_2))])

crqa_1rnd_sur <- ldply(seq_along(y_1rnd_sur$V1), function(r) crqa_cl(y1 = as.numeric(y_1rnd_sur[r,]), eDim  = 1, eLag = 1, eRad= 1)$rqa_measures)
crqa_1rnd_sur[NROW(crqa_1rnd_sur)+1,] <- crqa_1
crqa_2rnd_sur <- ldply(seq_along(y_2rnd_sur$V1), function(r) crqa_cl(y1 = as.numeric(y_2rnd_sur[r,]), eDim  = 1, eLag = 1, eRad= 1)$rqa_measures)
crqa_2rnd_sur[NROW(crqa_2rnd_sur)+1,] <- crqa_2


# Get point estimates for p-values based on rank of observation (discrete distribution)
#   99 = (1 / alpha) - 1
# 99+1 = (1 / alpha)
alpha = 1/100
p_1 <- 1 - ((unique(min_rank(crqa_1rnd_sur$DET)[which(crqa_1rnd_sur$DET%in%crqa_1$DET)])-1) * alpha)
p_2 <- 1 - ((unique(min_rank(crqa_2rnd_sur$DET)[which(crqa_2rnd_sur$DET%in%crqa_2$DET)])-1) * alpha)

g_1sur <- ggplot(crqa_1rnd_sur, aes(x=crqa_1rnd_sur$DET)) +
  geom_histogram(binwidth=.01, center=0, colour="white", fill="grey50") + 
  geom_point(data=crqa_1, aes(x=DET),y=0,colour="red",size=5) +
  xlab("DETerminism") + theme_bw()

g_2sur <- ggplot(crqa_2rnd_sur, aes(x=crqa_2rnd_sur$DET)) +
  geom_histogram(binwidth=.01, center=0, colour="white", fill="grey50") + 
  geom_point(data=crqa_2, aes(x=DET),y=0,colour="red",size=5) +
  xlab("DETerminism") + theme_bw()
```

The red dots indicate the observed values.
```{r RNG5a, echo=FALSE}
cowplot::plot_grid(g_1sur, g_2sur, labels = c(paste0("ID 163 - P(X=",round(crqa_1$DET,2),") = ",p_1), paste0("ID 291 - P(X=",round(crqa_2$DET,2),") = ",p_2), align = "h"))
```


To get the full picture, let's look at those missing repetitions of the same numbers.

```{r RNG6, echo=TRUE, message=FALSE, warning=FALSE, cache=TRUE, paged.print=FALSE}
set.seed(123456789)

# Get point estimates for p-values based on rank of observation (discrete distribution)
#   99 = (1 / alpha) - 1
# 99+1 = (1 / alpha)
alpha = 1/100
p_1 <- 1 - ((unique(min_rank(crqa_1rnd_sur$LAM)[which(crqa_1rnd_sur$LAM%in%crqa_1$LAM)])-1) * alpha)
p_2 <- 1 - ((unique(min_rank(crqa_2rnd_sur$LAM)[which(crqa_2rnd_sur$LAM%in%crqa_2$LAM)])-1) * alpha)

g_1sur <- ggplot(crqa_1rnd_sur, aes(x=crqa_1rnd_sur$LAM)) +
  geom_histogram(binwidth=.01, center=0, colour="white", fill="grey50") + 
  geom_point(data=crqa_1, aes(x=LAM),y=0,colour="red",size=5) +
  xlab("LAMinarity")

g_2sur <- ggplot(crqa_2rnd_sur, aes(x=crqa_2rnd_sur$LAM)) +
  geom_histogram(binwidth=.01, center=0, colour="white", fill="grey50") + 
  geom_point(data=crqa_2, aes(x=LAM),y=0,colour="red",size=5) +
  xlab("LAMinarity")


cowplot::plot_grid(g_1sur, g_2sur, labels = c(paste0("ID 163 - P(X=",round(crqa_1$LAM,2),") = ",p_1), paste0("ID 291 - P(X=",round(crqa_2$LAM,2),") = ",p_2), align = "h"))
```

If we were naive to the orgin of these number sequences, the results for **LAM**inarity should make us doubt that they represent indendent draws from a discrete uniform distribution of the type $X \sim \mathcal{U}(1,9)$. If we had to decide which sequence was more, or, less random, then based on the **DET**erminism result, we would conclude that participant 163 produced a sequence that is less random than participant 291, the observed value of the former is at the right extreme of a distribution of `DET` values calculated from 99 realisations of the data constrained by $H_0$.


## Cross RQA



## Sliding window




## References
